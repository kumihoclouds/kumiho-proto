// SPDX-License-Identifier: MIT
//
// MIT License
// Copyright (c) 2025 kumihoclouds
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in all
// copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
// SOFTWARE.

syntax = "proto3";

package kumiho;

// A Kumiho Reference (Kref) uniquely identifies any object in the system.
message Kref {
    string uri = 1;
}

// An Edge represents a directed, typed relationship between two revisions.
message Edge {
    Kref source_kref = 1;
    Kref target_kref = 2;
    string edge_type = 3;
    map<string, string> metadata = 4;
    string created_at = 5;
    string author = 6;
    string username = 7;
}

// --- Generic Messages ---

message StatusResponse {
    bool success = 1;
    string message = 2;
}

// Pagination parameters for list requests
message PaginationRequest {
    // Maximum number of items to return (default: 100, max: 1000)
    int32 page_size = 1;
    // Cursor for the next page (opaque string from previous response)
    string cursor = 2;
}

// Pagination info in list responses
message PaginationResponse {
    // Cursor for the next page, empty if no more results
    string next_cursor = 1;
    // Whether there are more results available
    bool has_more = 2;
    // Total count of items (if available, -1 if unknown)
    int32 total_count = 3;
}

message KrefRequest {
    Kref kref = 1;
}

message ResolveKrefRequest {
  string kref = 1;
  optional string tag = 2;
  optional string time = 3; // Time in YYYYMMDDHHMM format
}

message ResolveLocationRequest {
    string kref = 1;
    optional string tag = 2;
    optional string time = 3;
}

message ResolveLocationResponse {
    string location = 1;
    Kref resolved_kref = 2;
    string artifact_name = 3;
}

// --- Space Messages ---

message CreateSpaceRequest {
    string parent_path = 1;
    string space_name = 2;
    bool exists_error = 3;
}

message SpaceResponse {
    string path = 1;
    string created_at = 2;
    string modified_at = 3;
    string author = 4;
    map<string, string> metadata = 5;
    string username = 6;
    string name = 7;
    string type = 8; // "root" or "sub"
}

message GetSpaceRequest {
    string path_or_kref = 1;
}

message DeleteSpaceRequest {
    string path = 1;
    bool force = 2; // If true, allows admin to delete a space with items.
}

message GetChildSpacesRequest {
    string parent_path = 1; // Empty string for root level spaces
    bool recursive = 2;
    // Optional pagination parameters
    optional PaginationRequest pagination = 3;
}

message GetChildSpacesResponse {
    repeated SpaceResponse spaces = 1;
    // Pagination info for the response
    optional PaginationResponse pagination = 2;
}

// --- Item Messages ---

message CreateItemRequest {
    string parent_path = 1;
    string item_name = 2;
    string kind = 3;
    bool exists_error = 4;
}

message GetItemRequest {
    string parent_path = 1;
    string item_name = 2;
    string kind = 3;
}

message ItemResponse {
    Kref kref = 1;
    string name = 2;
    string item_name = 3;
    string kind = 4;
    string created_at = 5;
    string modified_at = 6;
    string author = 7;
    map<string, string> metadata = 8;
    bool deprecated = 9;
    string username = 10;
}

message DeleteItemRequest {
    Kref kref = 1;
    bool force = 2;
}

message GetItemsRequest {
    string parent_path = 1;
    string item_name_filter = 2;
    string kind_filter = 3;
    // Optional pagination parameters
    optional PaginationRequest pagination = 4;
}

message GetItemsResponse {
    repeated ItemResponse items = 1;
    // Pagination info for the response
    optional PaginationResponse pagination = 2;
}

message ItemSearchRequest {
    string context_filter = 1;
    string item_name_filter = 2;
    string kind_filter = 3;
}

// --- Revision Messages ---

message CreateRevisionRequest {
    Kref item_kref = 1;
    map<string, string> metadata = 2;
    int32 number = 3; // 0 for next available, >0 for specific revision
    bool exists_error = 4;
}

message RevisionResponse {
    Kref kref = 1;
    Kref item_kref = 2;
    int32 number = 3;
    repeated string tags = 4;
    map<string, string> metadata = 5;
    string created_at = 6;
    string modified_at = 7;
    string author = 8;
    bool deprecated = 9;
    bool published = 10;
    bool latest = 11;
    string username = 12;
    optional string default_artifact = 13;
    string name = 14;
}

message DeleteRevisionRequest {
    Kref kref = 1;
    bool force = 2;
}

message GetRevisionsRequest {
    Kref item_kref = 1;
    // Optional pagination parameters
    optional PaginationRequest pagination = 2;
}

message GetRevisionsResponse {
    repeated RevisionResponse revisions = 1;
    // Pagination info for the response
    optional PaginationResponse pagination = 2;
}

// --- Artifact Messages ---

message CreateArtifactRequest {
    Kref revision_kref = 1;
    string name = 2;
    string location = 3;
    bool exists_error = 4;
}

message ArtifactResponse {
    Kref kref = 1;
    string location = 2;
    Kref revision_kref = 3;
    Kref item_kref = 4;
    string created_at = 5;
    string modified_at = 6;
    string author = 7;
    map<string, string> metadata = 8;
    bool deprecated = 9;
    string username = 10;
    string name = 11;
}

message GetArtifactRequest {
    Kref revision_kref = 1;
    string name = 2;
}

message GetArtifactsRequest {
    Kref revision_kref = 1;
}

message GetArtifactsResponse {
    repeated ArtifactResponse artifacts = 1;
}

message DeleteArtifactRequest {
    Kref kref = 1;
    bool force = 2;
}

message GetArtifactsByLocationRequest {
    string location = 1;
}

message GetArtifactsByLocationResponse {
    repeated ArtifactResponse artifacts = 1;
}

// --- Tagging Messages ---

message TagRevisionRequest {
    Kref kref = 1;
    string tag = 2;
}

message UnTagRevisionRequest {
    Kref kref = 1;
    string tag = 2;
}

message HasTagRequest {
    Kref kref = 1;
    string tag = 2;
}

message HasTagResponse {
    bool has_tag = 1;
}

message WasTaggedRequest {
    Kref kref = 1;
    string tag = 2;
}

message WasTaggedResponse {
    bool was_tagged = 1;
}

// --- Default Artifact Messages ---

message SetDefaultArtifactRequest {
    Kref revision_kref = 1;
    string artifact_name = 2;
}


// --- Edge Messages ---

message CreateEdgeRequest {
    Kref source_revision_kref = 1;
    Kref target_revision_kref = 2;
    string edge_type = 3;
    map<string, string> metadata = 4;
    bool exists_error = 5;
}

// --- Metadata Update Messages ---
message UpdateMetadataRequest {
    Kref kref = 1;
    map<string, string> metadata = 2;
}

// Set a single metadata attribute (upsert)
message SetAttributeRequest {
    Kref kref = 1;
    string key = 2;
    string value = 3;
}

// Get a single metadata attribute
message GetAttributeRequest {
    Kref kref = 1;
    string key = 2;
}

message GetAttributeResponse {
    string key = 1;
    string value = 2;
    bool exists = 3;
}

// Delete a single metadata attribute
message DeleteAttributeRequest {
    Kref kref = 1;
    string key = 2;
}

// --- Peek Next Revision Messages ---
message PeekNextRevisionRequest {
    Kref item_kref = 1;
}

message PeekNextRevisionResponse {
    int32 number = 1;
}

enum EdgeDirection {
    OUTGOING = 0;
    INCOMING = 1;
    BOTH = 2;
}

message GetEdgesRequest {
    Kref kref = 1; // The revision to get edges for.
    string edge_type_filter = 2; // Optional: if empty, returns all edges.
    EdgeDirection direction = 3; // Optional: defaults to OUTGOING
    // Optional pagination parameters
    optional PaginationRequest pagination = 4;
}

message GetEdgesResponse {
    repeated Edge edges = 1;
    repeated Kref revision_krefs = 2;
    // Pagination info for the response
    optional PaginationResponse pagination = 3;
}

message DeleteEdgeRequest {
    Kref source_kref = 1;
    Kref target_kref = 2;
    string edge_type = 3;
}

// --- Graph Traversal Messages ---

// Represents a single step in a traversal path
message PathStep {
    Kref revision_kref = 1;
    string edge_type = 2;      // The relationship type used to reach this node
    int32 depth = 3;           // Distance from the origin (0 = origin)
}

// Represents a complete path between two revisions
message RevisionPath {
    repeated PathStep steps = 1;
    int32 total_depth = 2;
}

// Request for transitive dependency/dependents traversal
message TraverseEdgesRequest {
    Kref origin_kref = 1;                    // Starting revision
    EdgeDirection direction = 2;              // OUTGOING = dependencies, INCOMING = dependents
    repeated string edge_type_filter = 3;     // Filter by edge types (empty = all)
    int32 max_depth = 4;                      // Maximum traversal depth (0 = default of 10)
    int32 limit = 5;                          // Max results to return (default 100)
    bool include_path = 6;                    // Whether to include full path info
}

message TraverseEdgesResponse {
    repeated RevisionPath paths = 1;           // If include_path=true
    repeated Kref revision_krefs = 2;          // Flat list of discovered revisions
    repeated Edge edges = 3;                   // All traversed edges
    int32 total_count = 4;                    // Total nodes found
    bool truncated = 5;                       // True if results were limited
}

// Request for shortest path between two revisions
message ShortestPathRequest {
    Kref source_kref = 1;
    Kref target_kref = 2;
    repeated string edge_type_filter = 3;     // Filter by edge types (empty = all)
    int32 max_depth = 4;                      // Maximum path length to search (default: 10)
    bool all_shortest = 5;                    // Return all shortest paths, not just one
}

message ShortestPathResponse {
    repeated RevisionPath paths = 1;           // One or more shortest paths
    bool path_exists = 2;                     // True if any path was found
    int32 path_length = 3;                    // Length of shortest path(s)
}

// Request for impact analysis (what depends on this revision, transitively)
message ImpactAnalysisRequest {
    Kref revision_kref = 1;
    repeated string edge_type_filter = 2;     // Usually ["DEPENDS_ON"]
    int32 max_depth = 3;                      // Default: 10
    int32 limit = 4;                          // Max results
}

message ImpactedRevision {
    Kref revision_kref = 1;
    Kref item_kref = 2;
    int32 impact_depth = 3;                   // How many hops away
    repeated string impact_path_types = 4;    // Edge types in the impact chain
}

message ImpactAnalysisResponse {
    repeated ImpactedRevision impacted_revisions = 1;
    int32 total_impacted = 2;
    bool truncated = 3;
}

// --- Bundle Messages ---
// Bundles are special items that aggregate other items.
// The "bundle" kind is reserved and cannot be created manually.

message CreateBundleRequest {
    string parent_path = 1;          // Space path where bundle will be created
    string bundle_name = 2;           // Name of the bundle
    map<string, string> metadata = 3; // Initial metadata
}

message BundleMember {
    Kref item_kref = 1;               // The item that is a member
    string added_at = 2;              // When the item was added to bundle
    string added_by = 3;              // Who added the item (author uuid)
    string added_by_username = 4;     // Username who added the item
    int32 added_in_revision = 5;      // Which bundle revision this was added
}

message AddBundleMemberRequest {
    Kref bundle_kref = 1;             // The bundle item kref
    Kref member_item_kref = 2;        // The item to add as member
    map<string, string> metadata = 3; // Optional metadata for revision tracking
}

message AddBundleMemberResponse {
    bool success = 1;
    string message = 2;
    RevisionResponse new_revision = 3;  // The new revision created for this change
}

message RemoveBundleMemberRequest {
    Kref bundle_kref = 1;             // The bundle item kref
    Kref member_item_kref = 2;        // The item to remove
    map<string, string> metadata = 3; // Optional metadata for revision tracking
}

message RemoveBundleMemberResponse {
    bool success = 1;
    string message = 2;
    RevisionResponse new_revision = 3;  // The new revision created for this change
}

message GetBundleMembersRequest {
    Kref bundle_kref = 1;             // The bundle item kref
    optional int32 revision_number = 2; // Optional: specific revision (default: latest)
}

message GetBundleMembersResponse {
    repeated BundleMember members = 1;
    int32 revision_number = 2;         // Which revision's membership this represents
    int32 total_count = 3;
}

message BundleRevisionHistory {
    int32 revision_number = 1;
    string action = 2;                // "ADDED" or "REMOVED"
    Kref member_item_kref = 3;        // The item that was added/removed
    string author = 4;
    string username = 5;
    string created_at = 6;
    map<string, string> metadata = 7; // Immutable audit metadata
}

message GetBundleHistoryRequest {
    Kref bundle_kref = 1;
}

message GetBundleHistoryResponse {
    repeated BundleRevisionHistory history = 1;
}

// --- Event Streaming Messages ---

message EventStreamRequest {
    // A routing key filter, e.g., "item.model.created" or "revision.tagged.*"
    // An empty string subscribes to all events.
    string routing_key_filter = 1;
    // A kref filter for filtering by object URI patterns, e.g., "kref://projectA/**/*.model"
    // Supports wildcards. An empty string means no kref filtering.
    string kref_filter = 2;
}

message Event {
    // A routing key describing the event, e.g., "item.model.created"
    string routing_key = 1;
    // The Kref of the object that was affected.
    Kref kref = 2;
    // Timestamp of the event.
    string timestamp = 3;
    // The user who triggered the event.
    string author = 4;
    // Tenant scope for isolation in shared deployments.
    string tenant_id = 5;
    // Additional details about the event, e.g., the tag that was added.
    map<string, string> details = 6;
    string username = 7;
}

// --- Project Messages (gRPC parity with HTTP) ---

message CreateProjectRequest {
    string name = 1;
    string description = 2;
}

message ProjectResponse {
    string project_id = 1;
    string name = 2;
    string description = 3;
    string created_at = 4;
    string updated_at = 5;
    bool deprecated = 6;
    bool allow_public = 7;
}

message GetProjectsRequest {
    // Reserved for future filters; currently unused.
}

message GetProjectsResponse {
    repeated ProjectResponse projects = 1;
}

message DeleteProjectRequest {
    string project_id = 1;
    // force=true lets owner/admin hard-delete; otherwise deprecates.
    bool force = 2;
}


message UpdateProjectRequest {
    string project_id = 1;
    optional bool allow_public = 2;
    optional string description = 3;
}

// The Kumiho service definition.
service KumihoService {
    // Project methods
    rpc CreateProject(CreateProjectRequest) returns (ProjectResponse);
    rpc GetProjects(GetProjectsRequest) returns (GetProjectsResponse);
    rpc UpdateProject(UpdateProjectRequest) returns (ProjectResponse);
    rpc DeleteProject(DeleteProjectRequest) returns (StatusResponse);

    // Space methods
    rpc CreateSpace(CreateSpaceRequest) returns (SpaceResponse);
    rpc GetSpace(GetSpaceRequest) returns (SpaceResponse);
    rpc GetChildSpaces(GetChildSpacesRequest) returns (GetChildSpacesResponse);
    rpc DeleteSpace(DeleteSpaceRequest) returns (StatusResponse);
    rpc UpdateSpaceMetadata(UpdateMetadataRequest) returns (SpaceResponse);

    // Item methods
    rpc CreateItem(CreateItemRequest) returns (ItemResponse);
    rpc GetItem(GetItemRequest) returns (ItemResponse);
    rpc GetItems(GetItemsRequest) returns (GetItemsResponse);
    rpc ItemSearch(ItemSearchRequest) returns (GetItemsResponse);
    rpc DeleteItem(DeleteItemRequest) returns (StatusResponse);
    rpc UpdateItemMetadata(UpdateMetadataRequest) returns (ItemResponse);

    // Revision methods
    rpc ResolveKref(ResolveKrefRequest) returns (RevisionResponse);
    rpc ResolveLocation(ResolveLocationRequest) returns (ResolveLocationResponse);
    rpc CreateRevision(CreateRevisionRequest) returns (RevisionResponse);
    rpc GetRevision(KrefRequest) returns (RevisionResponse);
    rpc GetRevisions(GetRevisionsRequest) returns (GetRevisionsResponse);
    rpc DeleteRevision(DeleteRevisionRequest) returns (StatusResponse);
    rpc PeekNextRevision(PeekNextRevisionRequest) returns (PeekNextRevisionResponse);
    rpc UpdateRevisionMetadata(UpdateMetadataRequest) returns (RevisionResponse);
    rpc TagRevision(TagRevisionRequest) returns (StatusResponse);
    rpc UnTagRevision(UnTagRevisionRequest) returns (StatusResponse);
    rpc HasTag(HasTagRequest) returns (HasTagResponse);
    rpc WasTagged(WasTaggedRequest) returns (WasTaggedResponse);
    rpc SetDefaultArtifact(SetDefaultArtifactRequest) returns (StatusResponse);

    // Artifact methods
    rpc CreateArtifact(CreateArtifactRequest) returns (ArtifactResponse);
    rpc GetArtifact(GetArtifactRequest) returns (ArtifactResponse);
    rpc GetArtifacts(GetArtifactsRequest) returns (GetArtifactsResponse);
    rpc GetArtifactsByLocation(GetArtifactsByLocationRequest) returns (GetArtifactsByLocationResponse);
    rpc DeleteArtifact(DeleteArtifactRequest) returns (StatusResponse);
    rpc UpdateArtifactMetadata(UpdateMetadataRequest) returns (ArtifactResponse);

    // Attribute methods (granular metadata operations)
    // These work on any entity type (Revision, Item, Artifact, Space) identified by kref
    rpc SetAttribute(SetAttributeRequest) returns (StatusResponse);
    rpc GetAttribute(GetAttributeRequest) returns (GetAttributeResponse);
    rpc DeleteAttribute(DeleteAttributeRequest) returns (StatusResponse);

    // Edge methods
    rpc CreateEdge(CreateEdgeRequest) returns (StatusResponse);
    rpc GetEdges(GetEdgesRequest) returns (GetEdgesResponse);
    rpc DeleteEdge(DeleteEdgeRequest) returns (StatusResponse);

    // Graph Traversal methods
    rpc TraverseEdges(TraverseEdgesRequest) returns (TraverseEdgesResponse);
    rpc FindShortestPath(ShortestPathRequest) returns (ShortestPathResponse);
    rpc AnalyzeImpact(ImpactAnalysisRequest) returns (ImpactAnalysisResponse);

    // Bundle methods
    rpc CreateBundle(CreateBundleRequest) returns (ItemResponse);
    rpc AddBundleMember(AddBundleMemberRequest) returns (AddBundleMemberResponse);
    rpc RemoveBundleMember(RemoveBundleMemberRequest) returns (RemoveBundleMemberResponse);
    rpc GetBundleMembers(GetBundleMembersRequest) returns (GetBundleMembersResponse);
    rpc GetBundleHistory(GetBundleHistoryRequest) returns (GetBundleHistoryResponse);

    // Tenant methods
    rpc GetTenantUsage(GetTenantUsageRequest) returns (TenantUsageResponse);

    // Event Streaming
    rpc EventStream(EventStreamRequest) returns (stream Event);

    // Deprecation methods
    rpc SetDeprecated(SetDeprecatedRequest) returns (StatusResponse);
}

message SetDeprecatedRequest {
    Kref kref = 1;
    bool deprecated = 2;
}

message GetTenantUsageRequest {
    // Empty request, context is derived from auth token
}

message TenantUsageResponse {
    int64 node_count = 1;
    int64 node_limit = 2;
    string tenant_id = 3;
}
